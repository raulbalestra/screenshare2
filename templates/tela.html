<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Visualização da Tela</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: #f0f0f0;
      text-align: center;
    }

    #screen {
      max-width: 100%;
      height: auto;
    }

    #message {
      margin-top: 50px;
      font-size: 24px;
      color: #555;
    }
  </style>
</head>
<body>
  <h2>Visualização da Tela - {{ localidade|default('') }}</h2>
  <img id="screen" src="" alt="Transmissão da Tela" style="display: none" />
  <div id="message">Aguardando o início da transmissão...</div>

  <script>
    const localidade = "{{ localidade|default('') }}"; // Pega a localidade passada pelo servidor
    const screenImage = document.getElementById("screen");
    const messageDiv = document.getElementById("message");

    let updateInterval;

    function checkForTransmission() {
      // URL da imagem com timestamp para evitar cache
      const imageUrl = `/${localidade}/screen.png?timestamp=${new Date().getTime()}`;

      // Cria um novo objeto Image para verificar se a imagem existe
      const img = new Image();
      img.onload = function () {
        // Se a imagem carregar com sucesso, exibe a imagem e esconde a mensagem
        screenImage.src = imageUrl;
        screenImage.style.display = "block";
        messageDiv.style.display = "none";
        // Inicia a atualização periódica da tela
        startUpdatingScreen();
      };
      img.onerror = function () {
        // Se a imagem não existir, exibe a mensagem e esconde a imagem
        handleNoTransmission();
      };
      img.src = imageUrl;
    }

    function updateScreen() {
      // Gera a URL correta com a localidade e evita cache
      const imageUrl = `/${localidade}/screen.png?timestamp=${new Date().getTime()}`;

      screenImage.onload = function() {
        // Imagem carregada com sucesso, nada a fazer
        screenImage.style.display = "block";
        messageDiv.style.display = "none";
      };

      screenImage.onerror = function() {
        // Se a imagem não carregar, exibe a mensagem e esconde a imagem
        handleNoTransmission();
      };

      screenImage.src = imageUrl;
    }

    function startUpdatingScreen() {
      // Se o intervalo já estiver definido, não faz nada
      if (updateInterval) return;
      // Atualiza a tela a cada 1 segundo
      updateInterval = setInterval(updateScreen, 1000);
    }

    function handleNoTransmission() {
      screenImage.style.display = "none";
      messageDiv.style.display = "block";
      messageDiv.textContent = "A transmissão não começou ainda.";
      // Limpa o intervalo de atualização, pois a transmissão foi interrompida
      if (updateInterval) {
        clearInterval(updateInterval);
        updateInterval = null;
      }
    }

    // Verifica inicialmente se a transmissão já começou
    checkForTransmission();

    // Verifica a cada 5 segundos se a transmissão começou
    setInterval(checkForTransmission, 5000);
  </script>
</body>
</html>
