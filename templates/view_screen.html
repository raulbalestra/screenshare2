<!DOCTYPE html>
<html>
<head>
    <title>Visualizar Tela Compartilhada - {{ localidade }}</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>
<body>
    <h2>Visualizar Tela Compartilhada - {{ localidade }}</h2>
    <video id="remoteVideo" autoplay style="width: 100%; height: auto;"></video>

    <script>
        const socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port);

        // Configuração do servidor STUN/TURN
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' }, // STUN server público
                {
                    urls: 'turn:turn.seuservidor.com:3478', // Substitua pelo seu servidor TURN
                    username: 'seu-usuario',
                    credential: 'sua-senha'
                }
            ]
        };

        let peerConnection = new RTCPeerConnection(configuration);
        
        peerConnection.ontrack = (event) => {
            const remoteVideo = document.getElementById('remoteVideo');
            if (remoteVideo.srcObject !== event.streams[0]) {
                remoteVideo.srcObject = event.streams[0];
            }
        };

        peerConnection.onicecandidate = event => {
            if (event.candidate) {
                socket.emit('ice_candidate', { candidate: event.candidate });
            }
        };

        socket.on('webrtc_offer', async (data) => {
            try {
                const remoteDesc = new RTCSessionDescription(data.sdp);
                await peerConnection.setRemoteDescription(remoteDesc);

                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                socket.emit('webrtc_answer', { sdp: peerConnection.localDescription });
            } catch (error) {
                console.error("Erro ao processar oferta: ", error);
            }
        });

        socket.on('ice_candidate', async (data) => {
            try {
                await peerConnection.addIceCandidate(data.candidate);
            } catch (e) {
                console.error("Erro ao adicionar candidato ICE: ", e);
            }
        });
    </script>
</body>
</html>
